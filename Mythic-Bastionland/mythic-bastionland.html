<!-- HIDDEN INPUTS -->
<input type="hidden" name="attr_sheetTab" value="character" />

<!-- SHEET SELECTOR -->
<!-- <div class="sheet-button-select">
  <button type="action" name="act_character">Knight</button>
  <button type="action" name="act_property">Property</button>
  <button type="action" name="act_notes">Notes</button>
</div> -->
<!-- END OF SHEET SELECTOR -->
<!-- CHARACTER SHEET -->
<div class="sheet-character">
  <div>
    <!-- Header -->
    <div class="header">
      <div class="header-line">
        <label>
          They were named:
          <input type="text" name="attr_character_name" id="name-input" />
        </label>
               <label>
          Known as the:
          <input type="text" name="attr_knight" id="knight-input" />
        </label>
      </div>
      <div class="header-line">
        <label>Glory:
          <input type="number" name="attr_glory" />
        </label>
        <label>Rank:
          <input type="text" name="attr_rank" readonly />
        </label>
      </div>
    </div>
    <!-- End of Header -->
  </div>
  <!-- Virtues, Armor, Ability and Passion -->
  <div class="virtues-armor-ability-and-passion">
    <!-- Virtues -->
    <div class="virtues">
      <div class="virtues-container">
        <h3>Virtues</h3>
        <div class="virtues-content">
          <div class="virtues-line">
            <label>
              Vigour
              <input type="text" name="attr_vigourCurrent" class="attribute-input" />
              /
              <input type="text" name="attr_vigourMax" class="attribute-input" />
            </label>
            <button type="roll" name="attr_rollVigour"
              value="&{template:test-under} {{rollName=@{character_name} saves Vigour}} {{result=[[1d20]]}} {{target=[[@{vigourCurrent}]]}}"
              class="virtue-button" />
          </div>
          <div class="virtues-line">
            <label>
              Clarity
              <input type="text" name="attr_clarityCurrent" class="attribute-input" />
              /
              <input type="text" name="attr_clarityMax" class="attribute-input" />
            </label>
            <button type="roll" name="attr_rollClarity"
              value="&{template:test-under} {{rollName=@{character_name} saves Clarity}} {{result=[[1d20]]}} {{target=[[@{clarityCurrent}]]}}"
              class="virtue-button" />
          </div>
          <div class="virtues-line">
            <label>
              Spirit
              <input type="text" id="spirit-current" name="attr_spiritCurrent" class="attribute-input" />
              /
              <input type="text" name="attr_spiritMax" class="attribute-input" />
            </label>
            <button type="roll" name="attr_rollSpirit"
              value="&{template:test-under} {{rollName=@{character_name} saves Spirit}} {{result=[[1d20]]}} {{target=[[@{spiritCurrent}]]}}"
              class="virtue-button" />
          </div>
                    <div class="virtues-line">
            <label><input type="checkbox" name="attr_fatigued" value="1" />Fatigued</label>
          </div>
          <div class="virtues-line" id="guard">
            <label>Guard (GD)<input type="text" name="attr_ac" />/<input type="text" name="attr_acMax" /></label>
          </div>
        </div>
      </div>
    </div>
    <!-- End of Virtues -->
    <!-- Armor -->
    <div class="armor">
      <div class="armor-container">
        <h3>Armor</h3>
        <div class="armor-content">
          <div class="armor-line">
            <input type="text" name="attr_armor_coat_desc" placeholder="Coat description" />
            <input type="number" name="attr_armor_coat_name" placeholder="0" class="armor_value" />
            <input type="checkbox" name="attr_armor_coat_score" value="1" />
          </div>
          <div class="armor-line">
            <input type="text" name="attr_armor_plate_desc" placeholder="Plate description" />
            <input type="number" name="attr_armor_plate_name" placeholder="0" class="armor_value" />
            <input type="checkbox" name="attr_armor_plate_score" value="1" />
          </div>
          <div class="armor-line">
            <input type="text" name="attr_armor_helm_desc" placeholder="Helm description" />
            <input type="number" name="attr_armor_helm_name" placeholder="0" class="armor_value" />
            <input type="checkbox" name="attr_armor_helm_score" value="1" />
          </div>
          <div class="armor-line">
            <input type="text" name="attr_armor_shield_desc" placeholder="Shield description" />
            <input type="number" name="attr_armor_shield_name" placeholder="0" class="armor_value" />
            <input type="checkbox" name="attr_armor_shield_score" value="1" />
          </div>
          <label>Armor<input class="armor-total" type="text" readonly name="attr_armorTotal" /></label>
        </div>
      </div>
    </div>
    <!-- End of Armor -->
    <!-- Ability and Passion -->
    <div class="ability-and-passion-container">
      <div>
        <input class="ability" name="attr_ability" type="text" placeholder="Ability" />
        <textarea class="ability-description" name="attr_abilityDescription" placeholder="Description"></textarea>
      </div>
      <div>
        <input class="passion" name="attr_passion" type="text" placeholder="Passion" />
        <textarea class="passion-description" name="attr_passionDescription" placeholder="Description"></textarea>
      </div>
    </div>
    <!-- End of Ability and Passion -->
  </div>
  <!-- End of Virtues, Armor, Ability and Passion -->
  <!-- Weapons -->
  <div class="weapons">
    <h3>Weapons</h3>
    <div class="weapon-grid">
      <div id="weapon-roll">
        <label class="weapon-roll-label">.</label>
      </div>
      <div id="weapon-name">
        <label>Name</label>
      </div>
      <div id="weapon-attack-type">
        <label>Type</label>
      </div>
      <div id="weapon-damage">
        <label class="weapon-damage-label">Damage</label>
      </div>
    </div>
          <div class="weapon">
                    <div class="weapon-grid">
          <div id="weapon-roll">
            <input type="hidden" name="attr_weaponRoll" value="0" />
            <button type="roll" name="AttackRoll" class="attack-roll"
              value="&{template:default} {{name=@{character_name} attacks with @{weaponNameSmite}}} {{Damage=[[@{weaponDamageSmite}]]}}"></button>
          </div>
          <div id="weapon-name">
            <input type="text" name="attr_weaponNameSmite" value="Smite" />
          </div>
          <div id="weapon-attack-type">
            <input type="text" name="attr_weaponTypeSmite" />
          </div>
          <div id="weapon-damage">
            <input type="text" name="attr_weaponDamageSmite" value="1d12" class="input-as-number" />
          </div>
        </div>
                <div class="weapon-grid">
          <div id="weapon-roll">
            <input type="hidden" name="attr_weaponRoll" value="0" />
            <button type="roll" name="AttackRoll" class="attack-roll"
              value="&{template:default} {{name=@{character_name} attacks with @{weaponNameAdvantage}}} {{Damage=[[@{weaponDamageAdvantage}]]}}"></button>
          </div>
          <div id="weapon-name">
            <input type="text" name="attr_weaponNameAdvantage" value="Advantage" />
          </div>
          <div id="weapon-attack-type">
            <input type="text" name="attr_weaponTypeAdvantage" />
          </div>
          <div id="weapon-damage">
            <input type="text" name="attr_weaponDamageAdvantage" value="1d8" class="input-as-number" />
          </div>
        </div>
        <div class="weapon-grid">
          <div id="weapon-roll">
            <input type="hidden" name="attr_weaponRoll" value="0" />
            <button type="roll" name="AttackRoll" class="attack-roll"
              value="&{template:default} {{name=@{character_name} attacks with @{weaponName}}} {{Damage=[[@{weaponDamage}]]}}"></button>
          </div>
          <div id="weapon-name">
            <input type="text" name="attr_weaponName" value="Dagger" />
          </div>
          <div id="weapon-attack-type">
            <input type="text" name="attr_weaponType" />
          </div>
          <div id="weapon-damage">
            <input type="text" name="attr_weaponDamage" value="1d6" class="input-as-number" />
          </div>
        </div>
    <fieldset class="repeating_weapons">
      <div class="weapon">
        <div class="weapon-grid">
          <div id="weapon-roll">
            <input type="hidden" name="attr_weaponRoll" value="0" />
            <button type="roll" name="AttackRoll" class="attack-roll"
              value="&{template:default} {{name=@{character_name} attacks with @{weaponName}}} {{Damage=[[@{weaponDamage}]]}}"></button>
          </div>
          <div id="weapon-name">
            <input type="text" name="attr_weaponName" />
          </div>
          <div id="weapon-attack-type">
            <input type="text" name="attr_weaponType" />
          </div>
          <div id="weapon-damage">
            <input type="text" name="attr_weaponDamage" value="1d6" class="input-as-number" />
          </div>
        </div>
      </div>
    </fieldset>
  </div>
  <!-- End of Weapons -->
  
  <!-- Recovery, Oath, Feats, and Gambits Section -->
  <div class="recovery-oath-feats-gambits">
    <div class="top-row">
            <div class="oath-section">
        <h3>OATH</h3>
        <div class="oath-content">
          <p>Seek the Myths</p>
          <p>Honour the Seers</p>
          <p>Protect the Realm</p>
        </div>
      <div class="recovery-section">
        <h3>Recovery</h3>
        <div class="recovery-content">
          <p><strong>VIG</strong> - Hospitality or consume Sustenance</p>
          <p><strong>CLA</strong> - Seer's guidance or consume Stimulant</p>
          <p><strong>SPI</strong> - Indulge passion or consume Sacrament</p>
          <p><strong>Gd/Fatigue</strong> - A moment's calm and rest</p>
        </div>
      </div>
      </div>
      <div class="feats-section">
        <h3>FEATS</h3>
        <div class="feats-content">
          <p><strong>SMITE</strong> - +d12 or Blast to a melee attack.<br>
          <em>VIG Save or become Fatigued.</em></p>
          <p><strong>FOCUS</strong> - Perform a Gambit without using a die.<br>
          <em>CLA Save or become Fatigued.</em></p>
          <p><strong>DENY</strong> - Discard a damage die rolled against you or a nearby Ally.<br>
          <em>SPI Save or become Fatigued.</em></p>
        </div>
      </div>
      <div class="gambits-section">
        <h3>GAMBITS</h3>
        <div class="gambits-content">
          <p><strong>Bolster</strong> the attack for +1 total damage</p>
          <p><strong>Move</strong> after the attack</p>
          <p><strong>Repel</strong> a foe away from you</p>
          <p><strong>Stop</strong> a foe from moving next turn</p>
          <p><strong>Impair</strong> a weapon on their next turn</p>
          <p><strong>Trap</strong> a shield until your next turn</p>
          <p><strong>Dismount</strong> a foe</p>
          <p><strong>Other</strong> effect of a similar level of impact</p>
        </div>
      </div>
    </div>
  </div>
  <!-- End of Recovery, Oath, Feats, and Gambits Section -->
</div>
<!-- END OF CHARACTER SHEET -->
<!-- PROPERTY AND NOTES CONTAINER -->
<div class="sheet-property-notes-container">
  <!-- PROPERTY SHEET -->
  <div class="sheet-property">
   <h3>Property</h3>
    <textarea name="attr_property" class="property"></textarea>
  </div>
  <!-- END OF PROPERTY SHEET -->
  <!-- NOTES SHEET -->
  <div class="sheet-notes">
     <h3>Notes</h3>
    <textarea name="attr_notes" class="notes"></textarea>
  </div>
  <!-- END OF NOTES SHEET -->
</div>
<!-- END OF PROPERTY AND NOTES CONTAINER -->
<!-- ROLLTEMPLATES -->
<rolltemplate class="sheet-rolltemplate-test-under">
  <div class="sheet-template-container">
    <div class="sheet-template-header">{{rollName}}</div>
    <!-- Mostra apenas o resultado da rolagem -->
    <div class="sheet-template-result">
      <span>{{result}}</span>
    </div>
    <!-- Avaliação de sucesso ou falha -->
    {{#^rollGreater() result target}}
    <div class="sheet-template-outcome-success">Success</div>
    {{/^rollGreater() result target}}
    {{#rollGreater() result target}}
    <div class="sheet-template-outcome-failure">Failure</div>
    {{/rollGreater() result target}}
  </div>
</rolltemplate>
<!-- END OF ROLLTEMPLATES -->
<!-- SCRIPTS -->
<script type="text/worker">
    // Tabs
    const buttonlist = ["character", "property", "notes"];
    buttonlist.forEach((button) => {
      on(`clicked:${button}`, function (event) {
        setAttrs({ sheetTab: button });
      });
    });

    // Calculate armor total based on checked pieces
    const armorPieces = [
      {score: 'armor_coat_score', value: 'armor_coat_name'},
      {score: 'armor_plate_score', value: 'armor_plate_name'},
      {score: 'armor_helm_score', value: 'armor_helm_name'},
      {score: 'armor_shield_score', value: 'armor_shield_name'}
    ];
    
    function calculateArmorTotal() {
      // Get all armor score and value attributes
      const attrsToGet = [];
      armorPieces.forEach(piece => {
        attrsToGet.push(piece.score, piece.value);
      });
      
      getAttrs(attrsToGet, function(values) {
        let total = 0;
        armorPieces.forEach(piece => {
          if(values[piece.score] === "1") {
            const armorValue = parseInt(values[piece.value]) || 0;
            total += armorValue;
          }
        });
        setAttrs({
          "armorTotal": total
        });
      });
    }

    // Listen for changes in any armor piece score or value
    armorPieces.forEach(piece => {
      on(`change:${piece.score}`, calculateArmorTotal);
      on(`change:${piece.value}`, calculateArmorTotal);
    });

    // Initial calculation when sheet opens
    on('sheet:opened', calculateArmorTotal);

    on("sheet:opened change:glory", function() {
      getAttrs(["glory"], function(values) {
        var glory = parseInt(values["glory"]) || 0;
        var rank = "Knight-Errant";
        if (glory >= 3 && glory <= 5) {
          rank = "Knight-Gallant";
        } else if (glory >= 6 && glory <= 8) {
          rank = "Knight-Tenant";
        } else if (glory >= 9 && glory <= 11) {
          rank = "Knight Dominant";
        } else if (glory >= 12) {
          rank = "Knight-Radiant";
        }
        setAttrs({"rank": rank});
      });
    });
</script>
<!-- END OF SCRIPTS -->