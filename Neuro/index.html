<div class="container">
    <input class="sheet-tab-value" type="hidden" name="attr_sheet_container" value="equipment" />
    <div>
        <button type="action" name="act_skills">Umiejętności</button>
        <button type="action" name="act_equipment">Wyposażenie</button>
    </div>
    <div class="menu-roll">
        <div>
            <div class="test-type-group">
                <input type="radio" name="attr_test_type_txt" value="0" checked>
                <p class="test-name">Test Zwykły</p>
            </div>
            <div class="test-type-group">
                <input type="radio" name="attr_test_type_txt" value="1">
                <p class="test-name">Test Otwarty</p>
            </div>
            <div class="test-type-group">
                <input type="radio" name="attr_test_type_txt" value="2">
                <p class="test-name">Test Walki</p>
            </div>
        </div>
        <div>
            <div class="diffculty-level-value">
                <input type="radio" class="diffculty-level-value-left-radio" name="attr_difficulty_lvl" value="0" checked>
                <p class="diffculty-level-value-text">Łatwy</p>
            </div>
            <div class="diffculty-level-value">
                <input type="radio" class="diffculty-level-value-left-radio" name="attr_difficulty_lvl" value="1">
                <p class="diffculty-level-value-text">Przeciętny</p>
            </div>
            <div class="diffculty-level-value">
                <input type="radio" class="diffculty-level-value-left-radio" name="attr_difficulty_lvl" value="2">
                <p class="diffculty-level-value-text">Problematyczny</p>
            </div>
            <div class="diffculty-level-value">
                <input type="radio" class="diffculty-level-value-left-radio" name="attr_difficulty_lvl" value="3">
                <p class="diffculty-level-value-text">Trudny</p>
            </div>
            <div class="diffculty-level-value">
                <input type="radio" class="diffculty-level-value-left-radio" name="attr_difficulty_lvl" value="4">
                <p class="diffculty-level-value-text">Bardzo Trudny</p>
            </div>
            <div class="diffculty-level-value">
                <input type="radio" class="diffculty-level-value-left-radio" name="attr_difficulty_lvl" value="5">
                <p class="diffculty-level-value-text">Cholernie Trudny</p>
            </div>
            <div class="diffculty-level-value">
                <input type="radio" class="diffculty-level-value-left-radio" name="attr_difficulty_lvl" value="6">
                <p class="diffculty-level-value-text">Fart</p>
                <input type="radio" class="diffculty-level-value-right-radio" name="attr_difficulty_max_lvl" value="6" checked>
            </div>
            <div class="diffculty-level-value">
                <input type="radio" class="diffculty-level-value-left-radio" name="attr_difficulty_lvl" value="7">
                <p class="diffculty-level-value-text">Mistrzowski</p>
                <input type="radio" class="diffculty-level-value-right-radio" name="attr_difficulty_max_lvl" value="7">
            </div>
            <div class="diffculty-level-value">
                <input type="radio" class="diffculty-level-value-left-radio" name="attr_difficulty_lvl" value="8">
                <p class="diffculty-level-value-text">Arcymistrzowski</p>
                <input type="radio" class="diffculty-level-value-right-radio" name="attr_difficulty_max_lvl" value="8">
            </div>
        </div>
    </div>
    <div class="equipment-container-tab">
        
        <h1>Broń Ręczna</h1>
        <div class="package-attack-type">
            <p><input type="radio" name="attr_melee_attack_type" value="0" checked>Atak</p>
            <p><input type="radio" name="attr_melee_attack_type" value="1">Obrona</p>
        </div>
        <div class="weapon-header">
            <div class="col-name">Nazwa</div>
            <div class="col-damage">Obrażenia</div>
            <div class="col-skill">Umiejętność</div>
            <div class="col-param small">PP</div>
            <div class="col-param small">A+</div>
            <div class="col-param small">O+</div>
            <div class="col-roll small">Roll</div>
        </div>
        
        <fieldset class="repeating_weapons">
            <div class="weapon-row">
            <div class="col-name">
                <input type="text" name="attr_weapon_name" />
            </div>
            <div class="col-damage">
                <input type="text" name="attr_weapon_damage" />
            </div>
            <div class="col-skill">
                <input type="hidden" name="attr_weapon_skill_value" />
                <select name="attr_weapon_type">
                    <option value="----">-------</option>
                    <option value="brawl">Bijatyka</option>
                    <option value="melee">Broń ręczna</option>
                    <option value="throw">Rzucanie</option>
                </select>
            </div>
            <div class="col-param small">
                <input type="text" name="attr_weapon_pp" value="0"/>
            </div>
            <div class="col-param small">
                <input type="text" name="attr_weapon_bonus_attack" value="0"/>
            </div>
            <div class="col-param small">
                <input type="text" name="attr_weapon_bonus_defence" value="0"/>
            </div>
            <div class="col-roll small">
                <button type="roll" name="act_roll_weapon" class="roll-weapon"></button>
            </div>
            </div>
        </fieldset>
  
    </div>

    <div class="skill-container-tab">
        
        <div>
            <div class="wsp-container">
                <p class="wsp-label" >Zręczność</p>
                <div class="wsp-inputs">
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Baza</p>
                        <input class="wsp-values" value="0" type="number" name="attr_zre">
                    </div>
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Mod</p>
                        <input class="wsp-values" value="0" type="number" name="attr_zre_mod">
                    </div>
                    <button type="action" name="act_test_zre" class="roll-button charsheet-wsp-roll-button"></button>
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Próg</p>
                        <input class="wsp-values" value="0" type="number" min="1" name="attr_difficulty_zre" readonly>
                    </div>
                </div>
            </div>
            <div class="skills-container">
                <div class="skills-package-container">
                    <span class="skills-package-name">Walka wręcz</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_bijatyka" class="roll-button"></button>
                        <p>Bijatyka</p>
                        <input type="number" value="0" name="attr_bijatyka">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_br_ręczna" class="roll-button"></button>
                        <p>Broń ręczna</p>
                        <input type="number" value="0" name="attr_br_ręczna">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_rzucanie" class="roll-button"></button>
                        <p>Rzucanie</p>
                        <input type="number" value="0" name="attr_rzucanie">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Prowadzenie pojazdów</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_samochód" class="roll-button"></button>
                        <p>Samochód</p>
                        <input type="number" value="0" name="attr_samochód">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_motocykl" class="roll-button"></button>
                        <p>Motocykl</p>
                        <input type="number" value="0" name="attr_motocykl">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_ciężarówka" class="roll-button"></button>
                        <p>Ciężarówka</p>
                        <input type="number" value="0" name="attr_ciężarówka">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Zdolności manulane</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_kr_kiesz" class="roll-button"></button>
                        <p>Kradzież kieszonkowa</p>
                        <input type="number" value="0" name="attr_kr_kiesz">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_otw_zamków" class="roll-button"></button>
                        <p>Otwieranie zamków</p>
                        <input type="number" value="0" name="attr_otw_zamków">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_zw_dłonie" class="roll-button"></button>
                        <p>Zwinne dłonie</p>
                        <input type="number" value="0" name="attr_zw_dłonie">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Broń strzelecka</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_pistolety" class="roll-button"></button>
                        <p>Pistolety</p>
                        <input type="number" value="0" name="attr_pistolety">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_karabiny" class="roll-button"></button>
                        <p>Karabiny</p>
                        <input type="number" value="0" name="attr_karabiny">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_br_maszynowa" class="roll-button"></button>
                        <p>Broń maszynowa</p>
                        <input type="number" value="0" name="attr_br_maszynowa">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Broń dystansowa</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_łuk" class="roll-button"></button>
                        <p>Łuk</p>
                        <input type="number" value="0" name="attr_łuk">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_kusza" class="roll-button"></button>
                        <p>Kusza</p>
                        <input type="number" value="0" name="attr_kusza">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_proca" class="roll-button"></button>
                        <p>Proca</p>
                        <input type="number" value="0" name="attr_proca">
                    </div>
                </div>
            </div>
            <div class="wsp-container">
                <p class="wsp-label">Percepcja</p>
                <div class="wsp-inputs">
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Baza</p>
                        <input class="wsp-values" value="0" type="number" name="attr_per">
                    </div>
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Mod</p>
                        <input class="wsp-values" value="0" type="number" name="attr_per_mod">
                    </div>
                    <button type="action" name="act_test_per" class="roll-button charsheet-wsp-roll-button"></button>
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Próg</p>
                        <input class="wsp-values" value="0" type="number" name="attr_difficulty_per" readonly>
                    </div>
                </div>
            </div>
            <div class="skills-container">
                <div class="skills-package-container">
                    <span class="skills-package-name">Orientacja w terenie</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_wycz_kier" class="roll-button"></button>
                        <p>Wyczucie kierunku</p>
                        <input type="number" value="0" name="attr_wycz_kier">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_przyg_pułapki" class="roll-button"></button>
                        <p>Przygotowanie pułapki</p>
                        <input type="number" value="0" name="attr_przyg_pułapki">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_tropienie" class="roll-button"></button>
                        <p>Tropienie</p>
                        <input type="number" value="0" name="attr_tropienie">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Spostrzegawczość</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_nasłuchiwanie" class="roll-button"></button>
                        <p>Nasłuchiwanie</p>
                        <input type="number" value="0" name="attr_nasłuchiwanie">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_wypatrywanie" class="roll-button"></button>
                        <p>Wypatrywanie</p>
                        <input type="number" value="0" name="attr_wypatrywanie">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_czujność" class="roll-button"></button>
                        <p>Czujność</p>
                        <input type="number" value="0" name="attr_czujność">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Kamuflaż</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_skradanie" class="roll-button"></button>
                        <p>Skradanie się</p>
                        <input type="number" value="0" name="attr_skradanie">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_ukrywanie" class="roll-button"></button>
                        <p>Ukrywanie się</p>
                        <input type="number" value="0" name="attr_ukrywanie">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_maskowanie" class="roll-button"></button>
                        <p>Maskowanie</p>
                        <input type="number" value="0" name="attr_maskowanie">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Przetrwanie</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_łowiectwo" class="roll-button"></button>
                        <p>Łowiectwo</p>
                        <input type="number" value="0" name="attr_łowiectwo">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_znaj_teren" class="roll-button"></button>
                        <p>Znajomość terenu</p>
                        <input type="number" value="0" name="attr_znaj_teren">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_zdob_wody" class="roll-button"></button>
                        <p>Zdobywanie wody</p>
                        <input type="number" value="0" name="attr_zdob_wody">
                    </div>
                </div>
            </div>
            <div class="wsp-container">
                <p class="wsp-label">Charakter</p>
                <div class="wsp-inputs">
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Baza</p>
                        <input class="wsp-values" value="0" type="number" name="attr_cha">
                    </div>
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Mod</p>
                        <input class="wsp-values" value="0" type="number" name="attr_cha_mod">
                    </div>
                    <button type="action" name="act_test_cha" class="roll-button charsheet-wsp-roll-button"></button>
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Próg</p>
                        <input class="wsp-values" value="0" type="number" name="attr_difficulty_cha" readonly>
                    </div>
                </div>
            </div>
            <div class="skills-container">
                <div class="skills-package-container">
                    <span class="skills-package-name">Negocjacje</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_zastraszanie" class="roll-button"></button>
                        <p>Zastraszanie</p>
                        <input type="number" value="0" name="attr_zastraszanie">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_perswazja" class="roll-button"></button>
                        <p>Persfazja</p>
                        <input type="number" value="0" name="attr_perswazja">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_zdol_przywódcze" class="roll-button"></button>
                        <p>Zdolności przywódcze</p>
                        <input type="number" value="0" name="attr_zdol_przywódcze">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Empatia</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_postrz_emocje" class="roll-button"></button>
                        <p>Postrzeganie emocji</p>
                        <input type="number" value="0" name="attr_postrz_emocje">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_blef" class="roll-button"></button>
                        <p>Blef</p>
                        <input type="number" value="0" name="attr_blef">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_opieka_zwierz" class="roll-button"></button>
                        <p>Opieka nad zwierzętami</p>
                        <input type="number" value="0" name="attr_opieka_zwierz">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Siła woli</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_odp_na_ból" class="roll-button"></button>
                        <p>Odporność na ból</p>
                        <input type="number" value="0" name="attr_odp_na_ból">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_niezłomność" class="roll-button"></button>
                        <p>Niezłomność</p>
                        <input type="number" value="0" name="attr_niezłomność">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_morale" class="roll-button"></button>
                        <p>Morale</p>
                        <input type="number" value="0" name="attr_morale">
                    </div>
                </div>
            </div>
            <div class="wsp-container">
                <p class="wsp-label">Spryt</p>
                <div class="wsp-inputs">
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Baza</p>
                        <input class="wsp-values" value="0" type="number" name="attr_spr">
                    </div>
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Mod</p>
                        <input class="wsp-values" value="0" type="number" name="attr_spr_mod">
                    </div>
                    <button type="action" name="act_test_spr" class="roll-button charsheet-wsp-roll-button"></button>
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Próg</p>
                        <input class="wsp-values" value="0" type="number" name="attr_difficulty_spr" readonly>
                    </div>
                </div>
            </div>
            <div class="skills-container">
                <div class="skills-package-container">
                    <span class="skills-package-name">Medycyna</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_pier_pomoc" class="roll-button"></button>
                        <p>Pierwsza Pomoc</p>
                        <input type="number" value="0" name="attr_pier_pomoc">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_lecz_ran" class="roll-button"></button>
                        <p>Leczenie ran</p>
                        <input type="number" value="0" name="attr_lecz_ran">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_lecz_chorób" class="roll-button"></button>
                        <p>Leczenie chorób</p>
                        <input type="number" value="0" name="attr_lecz_chorób">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Technika</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_mechanika" class="roll-button"></button>
                        <p>Mechanika</p>
                        <input type="number" value="0" name="attr_mechanika">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_elektronika" class="roll-button"></button>
                        <p>Elektronika</p>
                        <input type="number" value="0" name="attr_elektronika">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_komputery" class="roll-button"></button>
                        <p>Komputery</p>
                        <input type="number" value="0" name="attr_komputery">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Sprzęt</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_m_ciężkie" class="roll-button"></button>
                        <p>Maszyny ciężkie</p>
                        <input type="number" value="0" name="attr_m_ciężkie">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_w_bojowe" class="roll-button"></button>
                        <p>Wozy bojowe</p>
                        <input type="number" value="0" name="attr_w_bojowe">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_kutry" class="roll-button"></button>
                        <p>Kutry</p>
                        <input type="number" value="0" name="attr_kutry">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Pirotechnika</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_rusznikarstwo" class="roll-button"></button>
                        <p>Rusznikarstwo</p>
                        <input type="number" value="0" name="attr_rusznikarstwo">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_wyrzutnie" class="roll-button"></button>
                        <p>Wyrzutnie</p>
                        <input type="number" value="0" name="attr_wyrzutnie">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_mat_wyb" class="roll-button"></button>
                        <p>Materiały wybuchowe</p>
                        <input type="number" value="0" name="attr_mat_wyb">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Wiedza ogólna</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_w_ogólna_1" class="roll-button"></button>
                        <p>Tymczasowe</p>
                        <input type="number" value="0" name="attr_w_ogólna_1">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_w_ogólna_2" class="roll-button"></button>
                        <p>Tymczasowe</p>
                        <input type="number" value="0" name="attr_w_ogólna_2">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_w_ogólna_3" class="roll-button"></button>
                        <p>Tymczasowe</p>
                        <input type="number" value="0" name="attr_w_ogólna_3">
                    </div>
                </div>
            </div>
            <div class="wsp-container">
                <p class="wsp-label">Budowa</p>
                <div class="wsp-inputs">
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Baza</p>
                        <input class="wsp-values" value="0" type="number" name="attr_bud">
                    </div>
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Mod</p>
                        <input class="wsp-values" value="0" type="number" name="attr_bud_mod">
                    </div>
                    <button type="action" name="act_test_bud" class="roll-button charsheet-wsp-roll-button"></button>
                    <div class="wsp-pair">
                        <p class="wsp-pair-title">Próg</p>
                        <input class="wsp-values" value="0" type="number" name="attr_difficulty_bud" readonly>
                    </div>
                </div>
            </div>
            <div class="skills-container">
                <div class="skills-package-container">
                    <span class="skills-package-name">Sprawność</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_kondycja" class="roll-button"></button>
                        <p>Kondycja</p>
                        <input type="number" value="0" name="attr_kondycja">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_pływanie" class="roll-button"></button>
                        <p>Pływanie</p>
                        <input type="number" value="0" name="attr_pływanie">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_wspinaczka" class="roll-button"></button>
                        <p>Wspinaczka</p>
                        <input type="number" value="0" name="attr_wspinaczka">
                    </div>
                </div>
                <div class="skills-package-container">
                    <span class="skills-package-name">Jeździectwo</span>
                    <div class="skill-container">
                        <button type="action" name="act_test_j_konna" class="roll-button"></button>
                        <p>Jazda Konna</p>
                        <input type="number" value="0" name="attr_j_konna">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_powożenie" class="roll-button"></button>
                        <p>Powożenie</p>
                        <input type="number" value="0" name="attr_powożenie">
                    </div>
                    <div class="skill-container">
                        <button type="action" name="act_test_ujeżdżanie" class="roll-button"></button>
                        <p>Ujeżdzanie</p>
                        <input type="number" value="0" name="attr_ujeżdżanie">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- <script> -->
<script type="text/worker">
    function clamp(val, min, max) {
        return Math.max(min, Math.min(val, max));
    }
    function count_number(arr, target){
        return arr.filter(n => n === target).length;
    }
    //####################################
    //###############CODES################
    //####################################
    wsp_code = ["zre", "per", "cha", "spr", "bud"];
    wsp_code_translate={
        "zre":"Zręczność", 
        "per":"Percepcja", 
        "cha":"Charakter", 
        "spr":"Spryt", 
        "bud":"Budowa",
    }
    skill_code = {
        "zre": [
          "bijatyka",
          "br_ręczna",
          "rzucanie",
          "samochód",
          "motocykl",
          "ciężarówka",
          "kr_kiesz",
          "otw_zamków",
          "zw_dłonie",
          "pistolety",
          "karabiny",
          "br_maszynowa",
          "łuk",
          "kusza",
          "proca"
        ],
        "per": [
          "wycz_kier",
          "przyg_pułapki",
          "tropienie",
          "nasłuchiwanie",
          "wypatrywanie",
          "czujność",
          "skradanie",
          "ukrywanie",
          "maskowanie",
          "łowiectwo",
          "znaj_teren",
          "zdob_wody"
        ],
        "cha": [
          "zastraszanie",
          "perswazja",
          "zdol_przywódcze",
          "postrz_emocje",
          "blef",
          "opieka_zwierz",
          "odp_na_ból",
          "niezłomność",
          "morale"
        ],
        "spr": [
          "pier_pomoc",
          "lecz_ran",
          "lecz_chorób",
          "mechanika",
          "elektronika",
          "komputery",
          "m_ciężkie",
          "w_bojowe",
          "kutry",
          "rusznikarstwo",
          "wyrzutnie",
          "mat_wyb",
          "w_ogólna_1",
          "w_ogólna_2",
          "w_ogólna_3"
        ],
        "bud": [
          "kondycja",
          "pływanie",
          "wspinaczka",
          "j_konna",
          "powożenie",
          "ujeżdżanie"
        ]
    }
    skill_code_translate={
        "bijatyka": "Bijatyka",
        "br_ręczna": "Broń ręczna",
        "rzucanie": "Rzucanie",
        "samochód": "Samochód",
        "motocykl": "Motocykl",
        "ciężarówka": "Ciężarówka",
        "kr_kiesz": "Kradzież kieszonkowa",
        "otw_zamków": "Otwieranie zamków",
        "zw_dłonie": "Zwinne dłonie",
        "pistolety": "Pistolety",
        "karabiny": "Karabiny",
        "br_maszynowa": "Broń maszynowa",
        "łuk": "Łuk",
        "kusza": "Kusza",
        "proca": "Proca",
      
        "wycz_kier": "Wyczucie kierunku",
        "przyg_pułapki": "Przygotowanie pułapki",
        "tropienie": "Tropienie",
        "nasłuchiwanie": "Nasłuchiwanie",
        "wypatrywanie": "Wypatrywanie",
        "czujność": "Czujność",
        "skradanie": "Skradanie się",
        "ukrywanie": "Ukrywanie się",
        "maskowanie": "Maskowanie",
        "łowiectwo": "Łowiectwo",
        "znaj_teren": "Znajomość terenu",
        "zdob_wody": "Zdobywanie wody",
      
        "zastraszanie": "Zastraszanie",
        "perswazja": "Perswazja",
        "zdol_przywódcze": "Zdolności przywódcze",
        "postrz_emocje": "Postrzeganie emocji",
        "blef": "Blef",
        "opieka_zwierz": "Opieka nad zwierzętami",
        "odp_na_ból": "Odporność na ból",
        "niezłomność": "Niezłomność",
        "morale": "Morale",
      
        "pier_pomoc": "Pierwsza pomoc",
        "lecz_ran": "Leczenie ran",
        "lecz_chorób": "Leczenie chorób",
        "mechanika": "Mechanika",
        "elektronika": "Elektronika",
        "komputery": "Komputery",
        "m_ciężkie": "Maszyny ciężkie",
        "w_bojowe": "Wozy bojowe",
        "kutry": "Kutry",
        "rusznikarstwo": "Rusznikarstwo",
        "wyrzutnie": "Wyrzutnie",
        "mat_wyb": "Materiały wybuchowe",
        "w_ogólna_1": "Wiedza ogólna",
        "w_ogólna_2": "Wiedza ogólna",
        "w_ogólna_3": "Wiedza ogólna",
      
        "kondycja": "Kondycja",
        "pływanie": "Pływanie",
        "wspinaczka": "Wspinaczka",
        "j_konna": "Jazda konna",
        "powożenie": "Powożenie",
        "ujeżdżanie": "Ujeżdżanie"
    }
      
      
    difficulty_values=[2,0,-2,-5,-8, -11, -15, -20, -24];

    const buttonlist = ["skills","equipment"];
    //####################################
    //################ROLL################
    //####################################
    function set_difficulty_level(rolls, current_difficulty, max_difficulty_level) {
            let difficulty_level = current_difficulty;
            difficulty_level += count_number(rolls, 20);
            difficulty_level -= count_number(rolls, 1);

            if (difficulty_level < 0) difficulty_mod = 0;
            if (difficulty_level > max_difficulty_level) difficulty_level = max_difficulty_level;

            return difficulty_level
        }
    function set_difficulty_level_skill(rolls, current_difficulty, max_difficulty_level,skill_level,test_type=true) {
            let difficulty_level = current_difficulty;
            difficulty_level += count_number(rolls, 20);
            difficulty_level -= count_number(rolls, 1);
            if (skill_level<1){
                difficulty_level++;
            }else{
                if(test_type){
                    difficulty_level-=Math.floor(skill_level/4);
                }
            }
            if (difficulty_level < 0) difficulty_mod = 0;
            if (difficulty_level > max_difficulty_level) difficulty_level = max_difficulty_level;

            return difficulty_level
        }
    
    function create_flag_success(rolls,difficulty){
        const flags = rolls.map(r => {
            return r <= difficulty ? 0 : 1;
        });
        return flags
    }

    function calculate_result_test(flags) {
        const success_num = flags.reduce((partialSum, a) => partialSum + a, 0);
        return success_num
    }
    function calculate_result_test_open(rolls, difficulty, points=0){
        let sorted_dices = rolls.concat().sort(function (a, b) { return a - b });
        while(points){
            if(sorted_dices[1]===1){
                break;
            }
            sorted_dices[1]--;
            sorted_dices = sorted_dices.concat().sort(function (a, b) { return a - b });
            points--;
        }
        return difficulty - sorted_dices[1];
    }
    wsp_code.forEach(element => {
            on(`clicked:test_${element}`, (info) => {
                name = wsp_code_translate[element]
                startRoll(`&{template:test} {{difficulty_lvl_val=[[0[computed value]]]}} {{test_name=${name}}} {{test_type_txt=[[0[computed value]]]}} {{res=[[0[computed value]]]}} {{roll1=[[1d20]]}} {{roll2=[[1d20]]}} {{roll3=[[1d20]]}} {{status1=[[0[computed value]]]}} {{status2=[[0[computed value]]]}} {{status3=[[0[computed value]]]}}`, (results) => {
                    const roll_dices = [results.results.roll1.result, results.results.roll2.result, results.results.roll3.result];
                    getAttrs([element, "test_type_txt", "difficulty_lvl", `${element}_mod`, "difficulty_max_lvl"], function (values) {
                        let difficulty = (parseInt(values[element] || 0))+(parseInt(values[`${element}_mod`] || 0));
                        const test_type = (parseInt(values["test_type_txt"] || 0));
                        const max_level_difficulty = clamp(parseInt(values["difficulty_max_lvl"]) || 6, 6, 8);
                        const difficulty_mod = set_difficulty_level(roll_dices, (parseInt(values["difficulty_lvl"] || 0)), max_level_difficulty);

                        difficulty += difficulty_values[difficulty_mod];
                        flags = create_flag_success(roll_dices, difficulty)
                        let final_result;
                        if (!test_type){
                            final_result = calculate_result_test(flags)
                        }else{
                            final_result = calculate_result_test_open(roll_dices, difficulty)
                        }
                        finishRoll(
                            results.rollId,
                            {
                                status1: flags[0],
                                status2: flags[1],
                                status3: flags[2],
                                res: final_result,
                                test_type_txt: test_type,
                                difficulty_lvl_val: difficulty_mod,
                            });
                    })
                });
            });
        });

    wsp_code.forEach(element => {
        on(`change:${element} change:${element}_mod change:difficulty_lvl sheet:opened`, function () {
            getAttrs(["difficulty_lvl", element, `${element}_mod`, "difficulty_max_lvl"], function (values) {
                const max_level_difficulty = clamp(parseInt(values["difficulty_max_lvl"]) || 6, 6, 8);
                const difficulty_lvl_index = clamp(parseInt(values["difficulty_lvl"]) || 0, 0, max_level_difficulty);
                const wsp = clamp((parseInt(values[element]) || 0), 0, 50);
                const wsp_mod = clamp((parseInt(values[`${element}_mod`]) || 0), 0, 50);
                setAttrs({
                    [`difficulty_${element}`]: wsp + wsp_mod + difficulty_values[difficulty_lvl_index],
                });
            });
        });
    });
    

    function create_flag_success_skill(rollDices, threshold, points) {
        const result = Array(rollDices.length).fill(0);
      
        const indexedRolls = rollDices
          .map((val, i) => [i, val])
          .sort((a, b) => a[1] - b[1]);
      
        for (const [i, val] of indexedRolls) {
          if (val <= threshold) continue;
      
          const diff = val - threshold;
      
          if (diff > points) {
            result[i] = 1;
          } else {
            points -= diff;
          }
        }
      
        return result;
      }
      

    for (const [key, value] of Object.entries(skill_code)){
        value.forEach(element=>{
            on(`clicked:test_${element}`,(info)=>{
                const name = `${skill_code_translate[element]}(${wsp_code_translate[key]})`;
                startRoll(`&{template:test} {{difficulty_lvl_val=[[0[computed value]]]}} {{test_name=${name}}} {{test_type_txt=[[0[computed value]]]}} {{res=[[0[computed value]]]}} {{roll1=[[1d20]]}} {{roll2=[[1d20]]}} {{roll3=[[1d20]]}} {{status1=[[0[computed value]]]}} {{status2=[[0[computed value]]]}} {{status3=[[0[computed value]]]}}`,(results)=>{
                    const roll_dices = [results.results.roll1.result, results.results.roll2.result, results.results.roll3.result];
                    getAttrs([element, key, "test_type_txt", "difficulty_lvl",`${key}_mod`, "difficulty_max_lvl"],function (values){
                        let difficulty = (parseInt(values[key] || 0))+(parseInt(values[`${key}_mod`] || 0));
                        const points = (parseInt(values[element] || 0));
                        const test_type = (parseInt(values["test_type_txt"] || 0));
                        const max_level_difficulty = clamp(parseInt(values["difficulty_max_lvl"]) || 6, 6, 8);
                        const difficulty_mod = set_difficulty_level_skill(roll_dices, (parseInt(values["difficulty_lvl"] || 0)), max_level_difficulty, points, test_type!==2);
                        difficulty += difficulty_values[difficulty_mod];
                        flags = create_flag_success_skill(roll_dices, difficulty, points);
                        let final_result;
                        if (!test_type){
                            final_result = calculate_result_test(flags)
                        }else{
                            final_result = calculate_result_test_open(roll_dices, difficulty, points);
                        }
                        finishRoll(
                            results.rollId,
                            {
                                status1: flags[0],
                                status2: flags[1],
                                status3: flags[2],
                                res: final_result,
                                test_type_txt: test_type,
                                difficulty_lvl_val: difficulty_mod,
                            });
                    });
                });
            });
        })
    }

    //####################################
    //#############DIFFICULTY#############
    //####################################
    on("change:difficulty_lvl sheet:opened", function(){
        getAttrs(["difficulty_lvl", "difficulty_max_lvl"],function(values){
            const max_level_difficulty = clamp(parseInt(values.difficulty_max_lvl) || 0, 6, 8);
            const difficulty_lvl_index = clamp(parseInt(values.difficulty_lvl) || 0, 0, 8);
            if (difficulty_lvl_index > max_level_difficulty){
                setAttrs({
                    "difficulty_lvl":max_level_difficulty
                });
            }
                
        });
    });
    on("change:difficulty_max_lvl sheet:opened", function(){
        getAttrs(["difficulty_lvl", "difficulty_max_lvl"],function(values){
            const max_level_difficulty = clamp(parseInt(values.difficulty_max_lvl) || 0, 6, 8);
            const difficulty_lvl_index = clamp(parseInt(values.difficulty_lvl) || 0, 0, 8);
            if (difficulty_lvl_index > max_level_difficulty){
                setAttrs({
                    "difficulty_lvl":max_level_difficulty
                });
            }
        });
    });

    buttonlist.forEach(button => {
        on(`clicked:${button}`, function() {
            setAttrs({
                "sheet_container": button
            });
        });
    });
    on("change:repeating_weapons:weapon_type", function(eventInfo) {
        const rowId = eventInfo.sourceAttribute.split("_")[2];
        const fullAttr = `repeating_weapons_${rowId}_weapon_type`;
    
        getAttrs([fullAttr], function(values) {
            const weaponType = values[fullAttr];
            let name_attr = "";
    
            switch (weaponType) {
                case "brawl":
                    name_attr = "bijatyka";
                    break;
                case "melee":
                    name_attr = "br_ręczna";
                    break;
                case "throw":
                    name_attr = "rzucanie";
                    break;
                default:
                    name_attr = "0";
            }
    
            if (name_attr === "0") {
                setAttrs({
                    [`repeating_weapons_${rowId}_weapon_skill_value`]: 0
                });
            } else {
                getAttrs([name_attr], function(value_attr) {
                    const skill_val = value_attr[name_attr] || 0;
                    console.log(skill_val)
                    setAttrs({
                        [`repeating_weapons_${rowId}_weapon_skill_value`]: skill_val
                    });
                });
            }
        });
    });
    
</script>

<rolltemplate class="sheet-rolltemplate-test">
    <div class="sheet-rolltemplate-container">
        <div class="sheet-rolltemplate-info">
            <h2>
                {{test_name}} - 
                {{#rollTotal() computed::test_type_txt 0}}Test Zamknięty{{/rollTotal() computed::test_type_txt 0}}
                {{#rollTotal() computed::test_type_txt 1}}Test Otwarty{{/rollTotal() computed::test_type_txt 1}}
                {{#rollTotal() computed::test_type_txt 2}}Test Walki{{/rollTotal() computed::test_type_txt 2}}
            </h2>
            <h2>
                {{#rollTotal() computed::difficulty_lvl_val 0}}Łatwy{{/rollTotal() computed::difficulty_lvl_val 0}}
                {{#rollTotal() computed::difficulty_lvl_val 1}}Przeciętny{{/rollTotal() computed::difficulty_lvl_val 1}}
                {{#rollTotal() computed::difficulty_lvl_val 2}}Problematyczny{{/rollTotal() computed::difficulty_lvl_val 2}}
                {{#rollTotal() computed::difficulty_lvl_val 3}}Trudny{{/rollTotal() computed::difficulty_lvl_val 3}}
                {{#rollTotal() computed::difficulty_lvl_val 4}}Bardzo Trudny{{/rollTotal() computed::difficulty_lvl_val 4}}
                {{#rollTotal() computed::difficulty_lvl_val 5}}Cholernie Trudny{{/rollTotal() computed::difficulty_lvl_val 5}}
                {{#rollTotal() computed::difficulty_lvl_val 6}}Fartowny{{/rollTotal() computed::difficulty_lvl_val 6}}
                {{#rollTotal() computed::difficulty_lvl_val 7}}Mistrzowski{{/rollTotal() computed::difficulty_lvl_val 7}}
                {{#rollTotal() computed::difficulty_lvl_val 8}}Arcymistrzowski{{/rollTotal() computed::difficulty_lvl_val 8}}
            </h2>              
            <h2>
                {{#rollTotal() computed::test_type_txt 0}}
                    {{#rollBetween() computed::res 0 1}}Sukces{{/rollBetween() computed::res 0 1}}
                    {{#rollBetween() computed::res 2 3}}Porażka{{/rollBetween() computed::res 2 3}}
                {{/rollTotal() computed::test_type_txt 0}}
                {{#rollTotal() computed::test_type_txt 1}}
                {{#rollBetween() computed::res 0 100}}Punkty sukcesu:{{/rollBetween() computed::res 0 100}}
                {{#rollBetween() computed::res -100 -1}}Punkty porażki:{{/rollBetween() computed::res -100 -1}}
                <span class="sheet-rolltemplate-open-result">{{computed::res}}</span>
                {{/rollTotal() computed::test_type_txt 1}}
            </h2>
        </div>
        <div class="sheet-rolltemplate-rolls">

            {{#rollTotal() computed::status1 0}}
            <div class="sheet-rolltemplate-value-testing sheet-rolltemplate-value-testing-succ">
            {{/rollTotal() computed::status1 0}}
            {{#rollTotal() computed::status1 1}}
            <div class="sheet-rolltemplate-value-testing sheet-rolltemplate-value-testing-fail">
            {{/rollTotal() computed::status1 1}}
                <p class="sheet-rolltemplate-result-dice-value">{{roll1}}</p>
            </div>

            {{#rollTotal() computed::status2 0}}
            <div class="sheet-rolltemplate-value-testing sheet-rolltemplate-value-testing-succ">
            {{/rollTotal() computed::status2 0}}
            {{#rollTotal() computed::status2 1}}
            <div class="sheet-rolltemplate-value-testing sheet-rolltemplate-value-testing-fail">
            {{/rollTotal() computed::status2 1}}
                <p class="sheet-rolltemplate-result-dice-value">{{roll2}}</p>
            </div>

            {{#rollTotal() computed::status3 0}}
            <div class="sheet-rolltemplate-value-testing sheet-rolltemplate-value-testing-succ">
            {{/rollTotal() computed::status3 0}}
            {{#rollTotal() computed::status3 1}}
            <div class="sheet-rolltemplate-value-testing sheet-rolltemplate-value-testing-fail">
            {{/rollTotal() computed::status3 1}}
            <p class="sheet-rolltemplate-result-dice-value">{{roll3}}</p>
            </div>
        </div>
    </div>
</rolltemplate>